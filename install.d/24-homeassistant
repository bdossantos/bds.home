#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

DEBUG=${DEBUG:=0}
[[ $DEBUG -eq 1 ]] && set -o xtrace

[[ $(hostname -s) != 'nestor' ]] && exit 0

apt-get install -y \
  bluetooth \
  libbluetooth-dev \
  libboost-python-dev \
  libboost-thread-dev \
  libcap2-bin \
  libglib2.0-dev \
  nmap \
  pkg-config \
  postgresql-9.6 \
  postgresql-server-dev-9.6 \
  python-dev \
  python-psycopg2 \
  python3-dev \
  python3-pip \
  python3-venv

cat <<SUPERVISOR_PG > /etc/supervisor/conf.d/postgresql.conf
[program:postgresql]
autorestart = true
command = /usr/lib/postgresql/9.6/bin/postgres -D /var/lib/postgresql/9.6/main -c config_file=/etc/postgresql/9.6/main/postgresql.conf
group = postgres
redirect_stderr = true
stderr_logfile = syslog
stdout_logfile = syslog
user = postgres
SUPERVISOR_PG

systemctl disable postgresql
service postgresql stop
supervisorctl reread
supervisorctl start postgresql

sudo -u postgres psql postgres -tAc \
  "SELECT 1 FROM pg_roles WHERE rolname='homeassistant'" | grep -q 1 \
  || sudo -u postgres createuser homeassistant

sudo -u postgres psql homeassistant -c '' 2>/dev/null \
  || sudo -u postgres createdb -O homeassistant homeassistant

adduser --system homeassistant
getent group homeassistant || addgroup homeassistant
usermod -G dialout -a homeassistant

# http://unix.stackexchange.com/questions/96106/bluetooth-le-scan-as-non-root
setcap cap_net_raw,cap_net_admin+eip \
  "$(readlink -f /srv/homeassistant/bin/python3)"

# shellcheck disable=SC2174
mkdir -m 0700 -p /srv/homeassistant
chown -R homeassistant:homeassistant /srv/homeassistant

sudo -u homeassistant pip3 install --upgrade virtualenv
sudo -u homeassistant python3 -m venv /srv/homeassistant
sudo -u homeassistant \
  bash -c 'source /srv/homeassistant/bin/activate \
    && pip3 install --upgrade homeassistant psycopg2'
cp files/home/homeassistant/.homeassistant/configuration.yaml \
  /home/homeassistant/.homeassistant/configuration.yaml
chown -R homeassistant:homeassistant /srv/homeassistant

cat <<SUPERVISOR_HASS > /etc/supervisor/conf.d/hass.conf
[program:hass]
autorestart = true
command = /srv/homeassistant/bin/hass
group = homeassistant
redirect_stderr = true
stderr_logfile = syslog
stdout_logfile = syslog
user = homeassistant
SUPERVISOR_HASS

supervisorctl reread
supervisorctl start hass
