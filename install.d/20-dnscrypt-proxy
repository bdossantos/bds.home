#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

DEBUG=${DEBUG:=0}
[[ $DEBUG -eq 1 ]] && set -o xtrace

DNSCRYPT_PROXY_PORT=53
DNSCRYPT_PROXY_VERSION='2.0.0rc3'
OS=$(uname)
ARCH=$(arch)

if [[ "$ARCH" == 'arm'* ]]; then
  ARCH='arm'
fi

apt-get purge -y dnsmasq
rm -rf /etc/dnsmasq.conf /etc/supervisor/conf.d/dnsmasq.conf

mkdir -p "$HOME/dnscrypt-proxy/${DNSCRYPT_PROXY_VERSION}" '/etc/hosts.d'

pushd "$HOME/dnscrypt-proxy/${DNSCRYPT_PROXY_VERSION}"

if [[ ! -f /usr/local/sbin/dnscrypt-proxy ]] ||
  ! /usr/local/sbin/dnscrypt-proxy -version | grep -q "$DNSCRYPT_PROXY_VERSION"; then
  wget \
    "https://github.com/jedisct1/dnscrypt-proxy/releases/download/${DNSCRYPT_PROXY_VERSION}/dnscrypt-proxy-${OS}_${ARCH}-${DNSCRYPT_PROXY_VERSION}.tar.gz" \
    -O "dnscrypt-proxy-${DNSCRYPT_PROXY_VERSION}.tar.gz"
  tar -zxf "dnscrypt-proxy-${DNSCRYPT_PROXY_VERSION}.tar.gz" --strip-components=1 -C \
    "$HOME/dnscrypt-proxy/${DNSCRYPT_PROXY_VERSION}"

  mv dnscrypt-proxy /usr/local/sbin/dnscrypt-proxy
  chown root.root /usr/local/sbin/dnscrypt-proxy
  chmod +x /usr/local/sbin/dnscrypt-proxy
fi

popd

# Running it as a non-root user
setcap cap_net_bind_service=+pe /usr/local/sbin/dnscrypt-proxy

# Consolidate /etc/hosts too just in case I don't use my DNS, eg: automatic
# network profile
curl 'https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling/hosts' \
  | sudo tee -a /etc/hosts

# YOLO
pushd files/etc/dnscrypt-proxy/ >/dev/null

python <(curl -Ss https://raw.githubusercontent.com/jedisct1/dnscrypt-proxy/35e32b823f2e722b7166c7464a90e9799e90c441/utils/generate-domains-blacklists/generate-domains-blacklist.py) \
  > /etc/dnscrypt-proxy-blacklist.txt

popd >/dev/null

cat <<DNSCRYPT-PROXY > /etc/dnscrypt-proxy.toml
block_ipv6 = true
cache = true
cache_max_ttl = 86400
cache_min_ttl = 600
cache_neg_ttl = 60
cache_size = 16000
cert_refresh_delay = 30
daemonize = false
fallback_resolver = '9.9.9.9:53'
force_tcp = false
ignore_system_dns = true
ipv4_servers = true
ipv6_servers = false
listen_addresses = ["0.0.0.0:${DNSCRYPT_PROXY_PORT}"]
max_clients = 100
require_dnssec = false
require_nofilter = true
require_nolog = true
timeout = 3000

[query_log]
  file = "/dev/null"
  format = "tsv"

[blacklist]
  blacklist_file = '/etc/dnscrypt-proxy-blacklist.txt'
  log_file = '/dev/null'
  format = "tsv"

[sources]
  [sources.'public-resolvers']
  url = 'https://download.dnscrypt.info/resolvers-list/v2/public-resolvers.md'
  cache_file = '/tmp/public-resolvers.md'
  format = 'v2'
  minisign_key = 'RWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3'
  refresh_delay = 72
  prefix = ''

[schedules]
  [schedules.'time-to-sleep']
  mon = [{after='23:00', before='7:00'}]
  tue = [{after='23:00', before='7:00'}]
  wed = [{after='23:00', before='7:00'}]
  thu = [{after='23:00', before='7:00'}]
  fri = [{after='00:00', before='7:00'}]
  sat = [{after='00:00', before='7:00'}]
  sun = [{after='23:00', before='7:00'}]

  [schedules.'work']
  mon = [{after='9:00', before='18:00'}]
  tue = [{after='9:00', before='18:00'}]
  wed = [{after='9:00', before='18:00'}]
  thu = [{after='9:00', before='18:00'}]
  fri = [{after='9:00', before='17:00'}]
DNSCRYPT-PROXY

rm -f /etc/supervisor/conf.d/dnscrypt-proxy-* /tmp/public-resolvers.md*

cat <<SUPERVISOR_DNSCRYPT > '/etc/supervisor/conf.d/dnscrypt-proxy.conf'
[program:dnscrypt-proxy]
autorestart = true
command = /usr/local/sbin/dnscrypt-proxy -loglevel 2 -config /etc/dnscrypt-proxy.toml
group = nogroup
redirect_stderr = true
stderr_logfile = syslog
stdout_logfile = syslog
user = nobody
SUPERVISOR_DNSCRYPT

# ensure `nobody` home directory exist to avoid chroot errors
# shellcheck disable=SC2174
mkdir -m 0700 -p /nonexistent
chown nobody.nogroup /nonexistent

systemctl daemon-reload
systemctl disable dnscrypt-proxy@.service || true
systemctl stop dnscrypt-proxy@\*

supervisorctl reread
supervisorctl update
supervisorctl start dnscrypt-proxy
