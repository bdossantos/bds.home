---

homeassistant:
  auth_providers:
    - type: homeassistant
  latitude: !secret home_latitude
  longitude: !secret home_longitude
  elevation: 30
  unit_system: metric
  time_zone: Europe/Paris
  name: BDS Home
  customize: !include_dir_merge_named customize

logger:
  default: warning
  logs:
    homeassistant.components.http.ban: warning

updater:
  reporting: false

frontend:

config:

http:
  server_port: 8080
  ip_ban_enabled: 'True'
  login_attempts_threshold: 3
  api_password: !secret api_password
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
    - 192.168.1.254
    - ::1

discovery:

conversation:

history:

logbook:

map:

sun:

tts:
  - platform: google
    cache: true
    cache_dir: /tmp/tts
    time_memory: 300
    language: 'en'

recorder:
  db_url: !secret db_url
  purge_interval: 1
  purge_keep_days: 30

hue:
  bridges:
    - host: 192.168.1.249
      filename: phue.conf
      allow_unreachable: true
      allow_hue_groups: false

scene: !include_dir_list scenes

light:
  - platform: group
    name: hallway lights
    entities:
      - light.hall1
  - platform: group
    name: kitchen lights
    entities:
      - light.kitchen1
  - platform: group
    name: livingroom lights
    entities:
      - light.livingroom1
      - light.livingroom2
      - light.livingroom3
      - light.livingroom4
  - platform: group
    name: bedroom lights
    entities:
      - light.bedroom1
      - light.bedroom2
      - light.bedroom3
  - platform: group
    name: dressing lights
    entities:
      - light.dressing1
      - light.dressing2
  - platform: group
    name: bathroom lights
    entities:
      - light.bathroom1
  - platform: group
    name: candle lights
    entities:
      - light.bedroom2
      - light.bedroom3
      - light.livingroom1
      - light.livingroom2
      - light.livingroom3
      - light.livingroom4

sensor:
  - platform: google_wifi
    host: 192.168.1.253
    monitored_conditions:
      - current_version
      - new_version
      - uptime
      - last_restart
      - status
  - platform: systemmonitor
    resources:
      - type: disk_use_percent
        arg: /
      - type: memory_use
      - type: memory_free
      - type: processor_use
      - type: network_in
        arg: eth0
      - type: network_out
        arg: eth0
      - type: last_boot
  - platform: speedtest
    minute:
      - 0
      - 30
    monitored_conditions:
      - ping
      - download
      - upload
  - platform: airvisual
    api_key: !secret airvisual_api_key
    monitored_conditions:
      - us
      - cn
    city: paris
    state: ile-de-france
    country: france
    radius: 10000
    show_on_map: false
  - platform: nest
  - platform: netatmo
    modules:
      indoor:
        - temperature
        - co2
        - pressure
        - noise
        - humidity
        - rain
        - sum_rain_1
        - sum_rain_24
        - windangle
        - windstrength
        - gustangle
        - guststrength
        - min_temp
        - max_temp
        - rf_status
        - battery_vp
  - platform: nut
    name: APC BE700G
    host: 192.168.1.250
    username: ups
    port: 3493
    resources:
      - battery.charge
      - battery.charge.low
      - battery.charge.warning
      - battery.date
      - battery.mfr.date
      - battery.runtime
      - battery.voltage
      - battery.voltage.nominal
      - input.voltage
      - input.voltage.nominal
      - ups.beeper.status
      - ups.load
      - ups.model
      - ups.status
      - ups.status.display
      - ups.timer.reboot
      - ups.timer.shutdown
  - platform: template
    sensors:
      hot_water_cylinder_amps:
        friendly_name_template: "{{ states.switch.hot_water_cylinder.name}} Current"
        value_template: '{{ states.switch.hot_water_cylinder.attributes["current_a"] | float }}'
        unit_of_measurement: 'A'
      hot_water_cylinder_watts:
        friendly_name_template: "{{ states.switch.hot_water_cylinder.name}} Current Consumption"
        value_template: '{{ states.switch.hot_water_cylinder.attributes["current_power_w"] | float }}'
        unit_of_measurement: 'W'
      hot_water_cylinder_total_kwh:
        friendly_name_template: "{{ states.switch.hot_water_cylinder.name}} Total Consumption"
        value_template: '{{ states.switch.hot_water_cylinder.attributes["total_energy_kwh"] | float }}'
        unit_of_measurement: 'kWh'
      hot_water_cylinder_volts:
        friendly_name_template: "{{ states.switch.hot_water_cylinder.name}} Voltage"
        value_template: '{{ states.switch.hot_water_cylinder.attributes["voltage"] | float }}'
        unit_of_measurement: 'V'
      hot_water_cylinder_today_kwh:
        friendly_name_template: "{{ states.switch.hot_water_cylinder.name}} Today's Consuption"
        value_template: '{{ states.switch.hot_water_cylinder.attributes["today_energy_kwh"] | float }}'
        unit_of_measurement: 'kWh'
  - platform: darksky
    api_key: !secret darksky_api_key
    update_interval: 600
    language: en
    monitored_conditions:
      - apparent_temperature
      - apparent_temperature_high
      - apparent_temperature_low
      - cloud_cover
      - daily_summary
      - dew_point
      - hourly_summary
      - humidity
      - minutely_summary
      - nearest_storm_distance
      - ozone
      - precip_accumulation
      - precip_intensity
      - precip_intensity_max
      - precip_probability
      - precip_type
      - pressure
      - summary
      - temperature
      - temperature_high
      - temperature_low
      - uv_index
      - visibility
      - wind_bearing
      - wind_speed
  - platform: meteo_france
    postal_code: 75017
    monitored_conditions:
      - temperature
      - weather
      - wind_speed
      - uv
      - next_rain
      - freeze_chance
      - rain_chance
      - snow_chance
      - thunder_chance
  - platform: template
    sensors:
      benjamin_status:
        value_template: '{{ states.input_select.benjamin_status_dropdown.state }}'
        friendly_name: 'Benjamin'
  - platform: cert_expiry
    host: bds.run
    name: bds.run
  - platform: cert_expiry
    host: b-ds.fr
    name: b-ds.fr
  - platform: statistics
    entity_id: sensor.bedroom_motion_temperature
    name: bedroom_temperature
  - platform: statistics
    entity_id: sensor.hallway_motion_temperature
    name: hallway_temperature
  - platform: statistics
    entity_id: sensor.kitchen_motion_temperature
    name: kitchen_temperature
  - platform: statistics
    entity_id: sensor.livingroom_motion_temperature
    name: livingroom_temperature
  - platform: statistics
    entity_id: sensor.bedroom_motion_luminance
    name: bedroom_luminance
  - platform: statistics
    entity_id: sensor.bedroom_motion_luminance
    name: bedroom_luminance
  - platform: statistics
    entity_id: sensor.kitchen_motion_luminance
    name: kitchen_luminance
  - platform: statistics
    entity_id: sensor.livingroom_motion_luminance
    name: livingroom_luminance
  - platform: history_stats
    name: Time in bed
    entity_id: binary_sensor.in_bed
    state: 'on'
    type: time
    end: '{{ now() }}'
    duration:
      hours: 24

binary_sensor:
  - platform: nest
  - platform: template
    sensors:
      front_door:
        friendly_name: 'Front door'
        device_class: door
        value_template: >-
          {% if is_state('sensor.fibaro_system_fgdw002_door_opening_sensor_2_access_control', '22') %}
            on
          {% elif is_state('sensor.fibaro_system_fgdw002_door_opening_sensor_2_access_control', '254') %}
            off
          {% else %}
            unknown
          {% endif %}
  - platform: template
    sensors:
      livingroom_door:
        friendly_name: 'Living room door'
        device_class: door
        value_template: >-
          {% if is_state('sensor.fibaro_system_fgdw002_door_opening_sensor_2_access_control_2', '22') %}
            on
          {% elif is_state('sensor.fibaro_system_fgdw002_door_opening_sensor_2_access_control_2', '254') %}
            off
          {% else %}
            unknown
          {% endif %}
  - platform: template
    sensors:
      time_in_bed_template:
        friendly_name: 'Time in bed'
        value_template: '{{ states.sensor.time_in_bed.attributes.value }}'
  - platform: bayesian
    name: 'in_bed'
    prior: 0.5
    probability_threshold: 0.85
    observations:
      - entity_id: 'group.family'
        prob_given_true: 0.99
        prob_given_false: 0.5
        platform: 'state'
        to_state: 'home'
      - entity_id: 'binary_sensor.livingroom_motion_sensor'
        prob_given_true: 0.9
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'off'
      - entity_id: 'binary_sensor.hallway_motion_sensor'
        prob_given_true: 0.9
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'off'
      - entity_id: 'binary_sensor.kitchen_motion_sensor'
        prob_given_true: 0.9
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'off'
      - entity_id: 'sun.sun'
        prob_given_true: 0.9
        prob_given_false: 0.2
        platform: 'state'
        to_state: 'below_horizon'
      - entity_id: 'group.all_lights'
        prob_given_true: 0.9
        prob_given_false: 0.4
        platform: 'state'
        to_state: 'off'

device_tracker:
  - platform: nmap_tracker
    home_interval: 10
    hosts: 192.168.1.10-20
    consider_home: 600
  - platform: ping
    home_interval: 10
    hosts:
      benjamin_smartphone: 192.168.1.11
      count: 2
    consider_home: 600
  - platform: bluetooth_tracker
    consider_home: 600
  - platform: tile
    consider_home: 600
    show_inactive: false
    username: !secret tile_username
    password: !secret tile_password
    monitored_variables:
      - TILE
      - PHONE

sonos:
  media_player:
    hosts:
      - 192.168.1.248
      - 192.168.1.245

switch:
  - platform: tplink
    host: 192.168.1.240
  - platform: tplink
    host: 192.168.1.241
    name: Hot Water Cylinder

nest:
  client_id: !secret nest_client_id
  client_secret: !secret nest_client_secret

netatmo:
  api_key: !secret netatmo_api_key
  secret_key: !secret netatmo_secret_key
  username: !secret netatmo_username
  password: !secret netatmo_password
  discovery: 'True'

group:
  default_view:
    name: Home
    icon: mdi:home
    view: 'True'
    entities:
      - group.family
      - group.input_booleans
      - group.door
      - group.hall
      - group.toilet
      - group.kitchen
      - group.livingroom
      - group.bedroom
      - group.dressing
      - group.bathroom
      - group.scenes
  sensor_view:
    name: Sensors
    icon: mdi:thermometer
    view: 'True'
    entities:
      - group.door
      - group.speedtest
      - group.netatmo
      - group.darksky
      - group.air_quality
      - history_graph.indoor_temperature
      - history_graph.indoor_luminance
      - history_graph.indoor_co2
      - history_graph.indoor_humidity
      - history_graph.indoor_noise
      - history_graph.outdoor_temperature
      - history_graph.outdoor_humidity
      - history_graph.outdoor_ozone
      - group.apc_be700g
  system_view:
    name: System
    icon: mdi:toolbox
    view: 'True'
    entities:
      - group.all_automations
      - group.all_scripts
  door:
    name: Door
    entities:
      - binary_sensor.front_door
      - binary_sensor.livingroom_door
  bathroom:
    name: Bathroom
    entities:
      - light.bathroom1
  bedroom:
    name: Bedroom
    entities:
      - light.bedroom1
      - light.bedroom2
      - light.bedroom3
      - binary_sensor.bedroom_motion_sensor
      - sensor.bedroom_motion_luminance
      - sensor.bedroom_motion_temperature
      - media_player.bedroom
  hall:
    name: Hall
    entities:
      - light.hall1
      - sensor.hallway_nest_protect_online
      - sensor.hallway_nest_protect_battery_health
      - sensor.hallway_nest_protect_co_status
      - sensor.hallway_nest_protect_color_status
      - sensor.hallway_nest_protect_smoke_status
      - binary_sensor.hallway_motion_sensor
      - sensor.hallway_motion_luminance
      - sensor.hallway_motion_temperature
  toilet:
    name: Toilet
    entities:
      - switch.hot_water_cylinder
      - sensor.hot_water_cylinder_amps
      - sensor.hot_water_cylinder_volts
      - sensor.hot_water_cylinder_watts
      - sensor.hot_water_cylinder_today_kwh
      - sensor.hot_water_cylinder_total_kwh
  kitchen:
    name: Kitchen
    entities:
      - light.kitchen1
      - switch.smartplugkitchen1
      - binary_sensor.kitchen_motion_sensor
      - sensor.kitchen_motion_luminance
      - sensor.kitchen_motion_temperature
      - binary_sensor.fridge_motion_sensor
      - sensor.fridge_motion_luminance
      - sensor.fridge_motion_temperature
  livingroom:
    name: Living Room
    entities:
      - light.livingroom1
      - light.livingroom2
      - light.livingroom3
      - light.livingroom4
      - binary_sensor.livingroom_motion_sensor
      - sensor.livingroom_motion_luminance
      - sensor.livingroom_motion_temperature
      - media_player.living_room
      - sensor.netatmo_indoor_temperature
      - sensor.netatmo_indoor_co2
      - sensor.netatmo_indoor_humidity
      - sensor.netatmo_indoor_noise
      - sensor.apc_be700g_input_voltage
      - sensor.apc_be700g_load
  dressing:
    name: Dressing
    entities:
      - light.dressing1
      - binary_sensor.dressing1_motion_sensor
      - sensor.dressing1_motion_luminance
      - sensor.dressing1_motion_temperature
      - light.dressing2
      - binary_sensor.dressing2_motion_sensor
      - sensor.dressing2_motion_luminance
      - sensor.dressing2_motion_temperature

  scenes:
    name: Scenes
    entities:
      - scene.all_lights_off
      - scene.nightlight
      - scene.candle
      - scene.candle_bedroom
      - scene.relax
      - scene.concentrate
      - scene.reading
      - scene.energize
      - scene.arctic
  speedtest:
    name: Internet
    entities:
      - sensor.speedtest_ping
      - sensor.speedtest_download
      - sensor.speedtest_upload
  air_quality:
    name: Paris Air quality
    entities:
      - sensor.us_air_pollution_level
      - sensor.us_air_quality_index
      - sensor.us_main_pollutant
  netatmo:
    name: Indoor metrics
    entities:
      - sensor.netatmo_indoor_co2
      - sensor.netatmo_indoor_humidity
      - sensor.netatmo_indoor_noise
      - sensor.netatmo_indoor_pressure
      - sensor.netatmo_indoor_temperature
      - sensor.netatmo_indoor_wifi
      - sensor.netatmo_outdoor_battery
      - sensor.netatmo_outdoor_humidity
      - sensor.netatmo_outdoor_radio
      - sensor.netatmo_outdoor_temperature
  darksky:
    name: Outdoor metrics
    entities:
      - sensor.dark_sky_daily_summary
      - sensor.dark_sky_daily_high_temperature
      - sensor.dark_sky_daily_low_temperature
      - sensor.dark_sky_humidity
      - sensor.dark_sky_ozone
      - sensor.dark_sky_precip_intensity
      - sensor.dark_sky_precip_probability
      - sensor.dark_sky_temperature
      - sensor.dark_sky_uv_index
      - sensor.dark_sky_wind_speed
  apc_be700g:
    name: APC BE700G
    entities:
      - sensor.apc_be700g_status
      - sensor.apc_be700g_battery_charge
      - sensor.apc_be700g_battery_runtime
      - sensor.apc_be700g_battery_voltage
      - sensor.apc_be700g_beeper_status
      - sensor.apc_be700g_input_voltage
      - sensor.apc_be700g_load
  benjamin_devices:
    name: Benjamin devices
    entities:
      - device_tracker.benjamin_smartphone
      - device_tracker.pixel3bdshome
  laura_devices:
    name: Laura devices
    entities:
      - device_tracker.iphone_laura
  tile:
    name: Tile
    entities:
      - device_tracker.tile_home_keys
      - device_tracker.tile_home_keys_double
      - device_tracker.tile_passport
  input_booleans:
    name: Home modes
    entities:
      - input_boolean.vacation_mode
      - input_boolean.guest_mode
  family:
    name: Family
    entities:
      - group.benjamin_devices
      - group.laura_devices
  all_media_players:
    name: All media players
    entities:
      - media_player.living_room
      - media_player.bedroom
  all_switchs:
    name: All switchs
    entities:
      - switch.smartplugkitchen1

input_select:
  benjamin_status_dropdown:
    name: Benjamin
    options:
      - Home
      - Just Arrived
      - Just Left
      - Away
      - Extended Away
    initial: Home

history_graph:
  indoor_temperature:
    name: Indoor temperature
    entities:
      - sensor.bedroom_motion_temperature
      - sensor.hallway_motion_temperature
      - sensor.kitchen_motion_temperature
      - sensor.livingroom_motion_temperature
    hours_to_show: 168
    refresh: 600
  indoor_luminance:
    name: Indoor luminance
    entities:
      - sensor.bedroom_motion_luminance
      - sensor.hallway_motion_luminance
      - sensor.kitchen_motion_luminance
      - sensor.livingroom_motion_luminance
    hours_to_show: 168
    refresh: 600
  indoor_co2:
    name: Indoor CO2
    entities:
      - sensor.netatmo_indoor_co2
    hours_to_show: 168
    refresh: 600
  indoor_humidity:
    name: Indoor humidity
    entities:
      - sensor.netatmo_indoor_humidity
    hours_to_show: 168
    refresh: 600
  indoor_noise:
    name: Indoor noise
    entities:
      - sensor.netatmo_indoor_noise
    hours_to_show: 24
    refresh: 60
  outdoor_temperature:
    name: Outdoor temperature
    entities:
      - sensor.dark_sky_temperature
    hours_to_show: 168
    refresh: 600
  outdoor_humidity:
    name: Outdoor humidity
    entities:
      - sensor.dark_sky_humidity
    hours_to_show: 168
    refresh: 600
  outdoor_ozone:
    name: Outdoor ozone
    entities:
      - sensor.dark_sky_ozone
    hours_to_show: 168
    refresh: 600

automation:
  - alias: 'Hass Startup Notification'
    initial_state: 'True'
    trigger:
      - platform: homeassistant
        event: start
    action:
      service: notify.slack
      data_template:
        message: ''
        data:
          attachments:
            - color: >
                good
              title: >
                :information_source: Information
              text: |
                Home Assistant restarted at {{ now().strftime('%c') }} :ok_hand:
  - alias: 'Hass Shutdown Notification'
    initial_state: 'True'
    trigger:
      - platform: homeassistant
        event: shutdown
    action:
      service: notify.slack
      data_template:
        message: ''
        data:
          attachments:
            - color: >
                warning
              title: >
                :warning: Warning
              text: |
                Home Assistant shutdown at {{ now().strftime('%c') }} :wave:
  - alias: 'Hass Update notifications'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: updater.updater
    action:
      service: notify.slack
      data_template:
        message: ''
        data:
          attachments:
            - color: >
                good
              title: >
                :information_source: Information
              text: |
                Home Assistant v {{ states('updater.updater') }} release is available! :champagne:
  - alias: 'Nest Protect smoke or carbon monoxide emergency'
    initial_state: 'True'
    trigger:
      platform: state
      entity_id:
        - sensor.hallway_nest_protect_smoke_status
        - sensor.hallway_nest_protect_co_status
      to: 'Emergency'
    action:
      - service: light.turn_on
        entity_id:
          - group.all_lights
        data:
          flash: long
          brightness_pct: 100
          white_value: 255
          kelvin: 4100
      - service: light.turn_on
        entity_id:
          - group.all_lights
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  danger
                title: >
                  :sos: Fatal
                text: |
                  There's smoke or carbon monoxide detected! :skull:
      - service: script.sonos_say
        data:
          sonos_entity: group.all_media_players
          volume: 0.5
          message: |
            There's smoke or carbon monoxide detected!
  - alias: 'APC status changed'
    initial_state: 'True'
    trigger:
      platform: state
      entity_id:
        - sensor.apc_be700g_status
    action:
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  danger
                title: >
                  :sos: Fatal
                text: |
                  APC status summary :battery:

                  Status: {{ states("sensor.apc_be700g_status") }}
                  Battery: {{ states("sensor.apc_be700g_battery_charge") }}
                  Battery runtime: {{ states("sensor.apc_be700g_battery_runtime") }}
                  Battery voltage: {{ states("sensor.apc_be700g_battery_voltage") }}
                  Input voltage: {{ states("sensor.apc_be700g_input_voltage") }}
                  Load: {{ states("sensor.apc_be700g_load") }}
  - alias: 'Power outage finished'
    initial_state: 'True'
    trigger:
      platform: state
      entity_id:
        - sensor.apc_be700g_status_data
      from: 'OB DISCHRG'
      to: 'OL CHRG'
    action:
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  Power is back! :battery:

      # wait few minutes to let hue bridge reboot after a power outage
      # TODO: buy an APC with more battery backed slots
      - delay: '00:02:00'
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  Turn all lights are off after the power outage :bulb:
      - service: scene.turn_on
        entity_id: scene.all_lights_off
  - alias: 'Nest Protect is Offline'
    initial_state: 'True'
    trigger:
      platform: state
      entity_id:
        - sensor.hallway_nest_protect_online
      from: 'on'
    action:
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  warning
                title: >
                  :warning: Warning
                text: |
                  Nest protect is Offline!
      - service: script.sonos_say
        data:
          sonos_entity: group.all_media_players
          volume: 0.5
          message: |
            'Nest protect is Offline!'
  - alias: 'Nest Protect is back Online'
    initial_state: 'True'
    trigger:
      platform: state
      entity_id:
        - sensor.hallway_nest_protect_online
      to: 'on'
    action:
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  Nest protect is back Online!
      - service: script.sonos_say
        data:
          sonos_entity: group.all_media_players
          volume: 0.5
          message: |
            Nest protect is back Online!
  - alias: 'Intrusion detection'
    initial_state: 'True'
    trigger:
      platform: state
      entity_id:
        - binary_sensor.bedroom_motion_sensor
        - binary_sensor.front_door
        - binary_sensor.hallway_motion_sensor
        - binary_sensor.kitchen_motion_sensor
        - binary_sensor.livingroom_motion_sensor
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.family
          state: 'not_home'
        - condition: state
          entity_id: input_boolean.guest_mode
          state: 'off'
    action:
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  danger
                title: >
                  :sos: Fatal
                text: |
                  Intrusion detected!
  - alias: Fridge temperature
    trigger:
      platform: numeric_state
      entity_id: sensor.fridge_motion_temperature
      above: 0
      below: 6
    action:
      service: notify.slack
      data_template:
        message: ''
        data:
          attachments:
            - color: >
                warning
              title: >
                :warning: Warning
              text: |
                Fridge temperature is {{ states('sensor.fridge_motion_temperature') }} :thermometer:
  - alias: '07:00 weekdays morning routine'
    initial_state: 'True'
    trigger:
      - platform: time
        at: '07:00:00'
    condition:
      - condition: state
        entity_id: group.family
        state: 'home'
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: state
        entity_id: input_boolean.guest_mode
        state: 'off'
    action:
      - service: switch.turn_on
        entity_id: switch.smartplugkitchen1
      - delay: '00:15:00'
      - service: scene.turn_on
        entity_id: scene.energize_kitchen
  - alias: 'Turn a few lights on when the sun gets dim'
    initial_state: 'True'
    trigger:
      platform: numeric_state
      entity_id: sun.sun
      value_template: '{{ state.attributes.elevation }}'
      below: 3.5
    condition:
      - condition: state
        entity_id: group.family
        state: 'home'
    action:
      - service: scene.turn_on
        entity_id: scene.candle
  - alias: 'Turn more lights on as the sun gets dimmer'
    initial_state: 'True'
    trigger:
      platform: numeric_state
      entity_id: sun.sun
      value_template: '{{ state.attributes.elevation }}'
      below: 1.5
    condition:
      - condition: state
        entity_id: group.family
        state: 'home'
    action:
      - service: scene.turn_on
        entity_id: scene.sun_gets_dimmer
  - alias: 'Turn on nightlight at dusk'
    initial_state: 'True'
    trigger:
      platform: numeric_state
      entity_id: sun.sun
      value_template: '{{ state.attributes.elevation }}'
      below: -5
    condition:
      - condition: state
        entity_id: group.family
        state: 'home'
    action:
      - service: scene.turn_on
        entity_id: scene.nightlight
  - alias: 'Turn on lights when dark and we Just Arrived'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: sensor.benjamin_status
        to: 'Just Arrived'
    condition:
      condition: or
      conditions:
        - condition: sun
          after: sunset
        - condition: sun
          before: sunrise
    action:
      - service: scene.turn_on
        entity_id: scene.just_arrived
      - service: switch.turn_on
        entity_id: switch.smartplugkitchen1
  - alias: 'Turn on kitchen lights when there is a movement'
    trigger:
      platform: state
      entity_id:
        - binary_sensor.kitchen_motion_sensor
      to: 'on'
    condition:
      - condition: numeric_state
        entity_id: sensor.kitchen_motion_luminance
        below: 150
    action:
      - service: switch.turn_on
        entity_id: switch.smartplugkitchen1
      - service: light.turn_on
        data_template:
          entity_id:
            - light.kitchen_lights
          color_temp: >
            {%- if now().strftime('%H') | int >= 20 %}
              450
            {%- elif now().strftime('%H') | int >= 7 %}
              350
            {%- else %}
              500
            {%- endif %}
          brightness_pct: >
            {%- if now().strftime('%H') | int >= 20 %}
              60
            {%- elif now().strftime('%H') | int >= 8 %}
              80
            {%- else %}
              50
            {%- endif %}
  - alias: 'Turn off kitchen lights 5 minutes after last movement'
    trigger:
      platform: state
      entity_id:
        - binary_sensor.kitchen_motion_sensor
      to: 'off'
      for:
        minutes: 5
    action:
      - service: switch.turn_off
        entity_id: switch.smartplugkitchen1
      - service: light.turn_off
        entity_id:
          - light.kitchen_lights
  - alias: 'Turn on dressing lights when there is a movement'
    trigger:
      platform: state
      entity_id:
        - binary_sensor.dressing1_motion_sensor
        - binary_sensor.dressing2_motion_sensor
      to: 'on'
    action:
      - service: light.turn_on
        data_template:
          entity_id:
            - light.dressing_lights
          color_temp: >
            {%- if now().strftime('%H') | int >= 20 %}
              450
            {%- elif now().strftime('%H') | int >= 7 %}
              350
            {%- else %}
              500
            {%- endif %}
          brightness_pct: >
            {%- if now().strftime('%H') | int >= 20 %}
              60
            {%- elif now().strftime('%H') | int >= 8 %}
              80
            {%- else %}
              50
            {%- endif %}
  - alias: 'Turn off dressing lights 2 minutes after last movement'
    trigger:
      platform: state
      entity_id:
        - binary_sensor.dressing1_motion_sensor
        - binary_sensor.dressing2_motion_sensor
      to: 'off'
      for:
        minutes: 2
    action:
      - service: light.turn_off
        entity_id:
          - light.dressing_lights
  - alias: 'Turn off Media Players when everybody is Away'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: sensor.benjamin_status
        to: 'Away'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.family
          state: 'not_home'
        - condition: state
          entity_id: input_boolean.guest_mode
          state: 'off'
    action:
      - service: media_player.turn_off
        entity_id: group.all_media_players
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  All media players was turned off :mute:
  - alias: 'Turn on living room lights when there is a movement and when dark'
    trigger:
      platform: state
      entity_id:
        - binary_sensor.livingroom_motion_sensor
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.family
          state: 'home'
        - condition: state
          entity_id:
            - light.livingroom3
            - light.livingroom4
          state: 'off'
        - condition: numeric_state
          entity_id: sensor.livingroom_motion_luminance
          below: 10
        - condition: or
          conditions:
            - condition: sun
              after: sunset
            - condition: sun
              before: sunrise
    action:
      - service: light.turn_on
        data_template:
          entity_id:
            - light.livingroom3
            - light.livingroom4
          color_temp: >
            {%- if now().strftime('%H') | int <= 9 %}
              350
            {%- else %}
              500
            {%- endif %}
          brightness_pct: >
            {%- if now().strftime('%H') | int <= 9 %}
              70
            {%- else %}
              50
            {%- endif %}
  - alias: 'Turn off lights when everybody is Away'
    initial_state: 'True'
    trigger:
      platform: state
      entity_id: sensor.benjamin_status
      to: 'Away'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.family
          state: 'not_home'
        - condition: state
          entity_id: input_boolean.guest_mode
          state: 'off'
        - condition: state
          entity_id: group.all_lights
          state: 'on'
    action:
      - service: scene.turn_on
        entity_id: scene.all_lights_off
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  All light turned off :bulb:
  - alias: 'Turn on vacation mode when away for 24h'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: group.family
        to: 'not_home'
        for:
          hours: 24
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.guest_mode
          state: 'off'
        - condition: state
          entity_id: input_boolean.vacation_mode
          state: 'off'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.vacation_mode
      - service: switch.turn_off
        entity_id: switch.hot_water_cylinder
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  Vacation mode had been turned on automatically because everyone is away since 24h :beach_with_umbrella:
  - alias: 'Turn off vacation mode when coming home'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: group.family
        to: 'home'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.guest_mode
          state: 'off'
        - condition: state
          entity_id: input_boolean.vacation_mode
          state: 'on'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.vacation_mode
      - service: switch.turn_on
        entity_id: switch.hot_water_cylinder
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  Vacation mode had been turned off :briefcase:
  - alias: 'Simulate presence'
    trigger:
      - platform: state
        entity_id: 'sun.sun'
        to: 'below_horizon'
      - platform: event
        event_type: event_simulate_presence
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: 'sun.sun'
          state: 'below_horizon'
        - condition: time
          before: '01:00:00'
        - condition: state
          entity_id: group.family
          state: 'not_home'
        - condition: state
          entity_id: input_boolean.guest_mode
          state: 'off'
    action:
      - service: notify.slack
        data_template:
          message: ''
          data:
            attachments:
              - color: >
                  good
                title: >
                  :information_source: Information
                text: |
                  Presence simulation triggered :speaking_head_in_silhouette:
      - service: scene.turn_on
        entity_id: scene.candle
      - delay: '00:00:{{ (range(1, 59)|random|int) }}'
      - service: light.turn_on
        entity_id: light.hall1
        data_template:
          rgb_color: [255, 255, 255]
          brightness_pct: '{{ (range(20, 100)|random|int) }}'
      - delay: '00:0{{ (range(1, 4) | random) }}:{{ (range(1, 59)|random|int) }}'
      - service: light.turn_on
        data_template:
          entity_id: >
            light.livingroom{{ (range(1, 2)|random|int) }}
      - delay: '00:00:{{ (range(10, 59)|random|int) }}'
      - service: light.turn_on
        data_template:
          entity_id: >
            light.livingroom{{ (range(3, 4)|random|int) }}
      - delay: '00:0{{ (range(1, 9) | random) }}:{{ (range(1, 59)|random|int) }}'
      - service: scene.turn_on
        entity_id: scene.all_lights_off
      - delay: '00:00:0{{ (range(1, 59)|random|int) }}'
      # generate an event to call again this automation rule
      - event: event_simulate_presence
  - alias: 'Turn off Hot water cylinder between 06:30 and 22:30'
    trigger:
      platform: time
      minutes: '/1'
      seconds: 00
    condition:
      condition: and
      conditions:
        - condition: time
          after: '06:30:00'
          before: '22:30:00'
        - condition: state
          entity_id: switch.hot_water_cylinder
          state: 'on'
        - condition: state
          entity_id: input_boolean.vacation_mode
          state: 'off'
          for:
            hours: 24
    action:
      - service: switch.turn_off
        entity_id: switch.hot_water_cylinder
  - alias: 'Turn on Hot water cylinder between 22:30 and 06:30'
    trigger:
      platform: time
      minutes: '/1'
      seconds: 00
    condition:
      condition: and
      conditions:
        - condition: time
          after: '22:30:00'
          before: '06:30:00'
        - condition: state
          entity_id: switch.hot_water_cylinder
          state: 'off'
        - condition: state
          entity_id: input_boolean.vacation_mode
          state: 'off'
    action:
      - service: switch.turn_on
        entity_id: switch.hot_water_cylinder
  # Automating Transitions Between States
  # https://philhawthorne.com/making-home-assistants-presence-detection-not-so-binary/
  - alias: 'Mark person as just arrived'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: group.benjamin_devices
        from: 'not_home'
        to: 'home'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'group.benjamin_devices' %}
              input_select.benjamin_status_dropdown
            {% endif %}
          option: >
            {% if trigger.entity_id == 'group.benjamin_devices' %}
              {% if states.input_select.benjamin_status_dropdown.state == 'Just Left' %}
                Home
              {% else %}
                Just Arrived
              {% endif %}
            {% endif %}
  - alias: 'Mark person as home'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: input_select.benjamin_status_dropdown
        to: 'Just Arrived'
        for:
          minutes: 10
      - platform: state
        entity_id: input_select.benjamin_status_dropdown
        from: 'Just Left'
        to: 'Just Arrived'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'input_select.benjamin_status_dropdown' %}
              input_select.benjamin_status_dropdown
            {% endif %}
          option: Home
  - alias: 'Mark person as just left'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: group.benjamin_devices
        from: 'home'
        to: 'not_home'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'group.benjamin_devices' %}
              input_select.benjamin_status_dropdown
            {% endif %}
          option: Just Left
  - alias: 'Mark person as away'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: input_select.benjamin_status_dropdown
        to: 'Just Left'
        for:
          minutes: 10
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'input_select.benjamin_status_dropdown' %}
              input_select.benjamin_status_dropdown
            {% endif %}
          option: Away
  - alias: 'Mark person as extended away'
    initial_state: 'True'
    trigger:
      - platform: state
        entity_id: input_select.benjamin_status_dropdown
        to: 'Away'
        for:
          hours: 24
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'input_select.benjamin_status_dropdown' %}
              input_select.benjamin_status_dropdown
            {% endif %}
          option: Extended Away

script:
  sonos_say:
    alias: 'Sonos TTS script'
    sequence:
      - service: media_player.sonos_snapshot
        data_template:
          entity_id: "{{ sonos_entity }}"
      - service: media_player.sonos_unjoin
        data_template:
          entity_id: "{{ sonos_entity }}"
      - service: media_player.volume_set
        data_template:
          entity_id: "{{ sonos_entity }}"
          volume_level: "{{ volume }}"
      - service: tts.google_say
        data_template:
          entity_id: "{{ sonos_entity }}"
          message: "{{ message }}"
      - delay: "{{ delay or '00:00:05' }}"
      - service: media_player.sonos_restore
        data_template:
          entity_id: "{{ sonos_entity }}"

input_boolean: !include input_boolean.yaml

notify:
  - name: slack
    platform: slack
    api_key: !secret slack_api_key
    default_channel: '#general'

zone:
  - name: Work
    latitude: !secret work_latitude
    longitude: !secret work_longitude
    elevation: 40
    icon: mdi:worker
    radius: 100

proximity:
  home:
    zone: home
    devices:
      - device_tracker.tile_bag__tnf_basecamp_s_black
      - device_tracker.tile_bag__tnf_borealis_backpack
      - device_tracker.tile_home_keys
      - device_tracker.tile_home_keys_double
      - device_tracker.tile_passport
    tolerance: 50
  work:
    zone: work
    devices:
      - device_tracker.tile_bag__pro_laptop_briefcase
      - device_tracker.tile_home_keys
    tolerance: 100

zwave:
  usb_path: /dev/ttyACM0
  network_key: !secret z_wave_network_key
